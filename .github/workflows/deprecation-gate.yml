name: Deprecation Detection Gate

on:
  pull_request:
    branches: [main, develop]
    paths:
      - '**/*.py'
      - '**/*.js'
      - '**/*.ts'
      - '**/*.jsx'
      - '**/*.tsx'
      - 'requirements*.txt'
      - 'package.json'
      - 'package-lock.json'
      - 'pyproject.toml'
      - 'poetry.lock'
      - '.deprecation-whitelist.json'
      - '.pre-commit-config.yaml'
  push:
    branches: [main, develop]
    paths:
      - '**/*.py'
      - '**/*.js'
      - '**/*.ts'
      - '**/*.jsx'
      - '**/*.tsx'
      - 'requirements*.txt'
      - 'package.json'
      - 'package-lock.json'
      - 'pyproject.toml'
      - 'poetry.lock'
      - '.deprecation-whitelist.json'
      - '.pre-commit-config.yaml'
  workflow_dispatch:

jobs:
  deprecation-detection:
    name: Deprecation Detection Gate
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Determine Validation Path
        id: validation_path
        run: |
          if [ -f "SCOPE_DECLARATION.md" ] && find . -maxdepth 1 -name "PREHANDOVER_PROOF_*.md" -type f | grep -q .; then
            echo "path=evidence" >> $GITHUB_OUTPUT
            echo "✓ Using evidence-based validation (BL-027/028)"
          else
            echo "path=script" >> $GITHUB_OUTPUT
            echo "✓ Using script-based validation (traditional)"
          fi

      - name: Set up Python
        if: steps.validation_path.outputs.path == 'script'
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Set up Node.js
        if: steps.validation_path.outputs.path == 'script'
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Install Python dependencies
        if: steps.validation_path.outputs.path == 'script'
        run: |
          python -m pip install --upgrade pip
          pip install ruff pre-commit
          # Install project dependencies if they exist
          if [ -f requirements.txt ]; then pip install -r requirements.txt; fi
          if [ -f requirements-dev.txt ]; then pip install -r requirements-dev.txt; fi

      - name: Install Node dependencies (if applicable)
        if: steps.validation_path.outputs.path == 'script'
        run: |
          if [ -f package.json ]; then
            npm ci || npm install
          fi

      - name: Check for Python files
        if: steps.validation_path.outputs.path == 'script'
        id: check_python
        run: |
          if find . -name "*.py" -not -path "./.git/*" -not -path "./venv/*" -not -path "./.venv/*" | grep -q .; then
            echo "has_python=true" >> $GITHUB_OUTPUT
          else
            echo "has_python=false" >> $GITHUB_OUTPUT
          fi

      - name: Check for JS/TS files
        if: steps.validation_path.outputs.path == 'script'
        id: check_js
        run: |
          if find . -name "*.js" -o -name "*.ts" -o -name "*.jsx" -o -name "*.tsx" | grep -v node_modules | grep -q .; then
            echo "has_js=true" >> $GITHUB_OUTPUT
          else
            echo "has_js=false" >> $GITHUB_OUTPUT
          fi

      - name: Run Ruff (Python deprecation detection)
        if: steps.validation_path.outputs.path == 'script' && steps.check_python.outputs.has_python == 'true'
        run: |
          echo "Running Python deprecation detection with Ruff..."
          ruff check . --select F,E,W,UP,B,A,C4,DTZ,PIE,RET,SIM,ARG,PTH --ignore E501 --output-format=github
        continue-on-error: false

      - name: Run ESLint (JavaScript/TypeScript deprecation detection)
        if: steps.validation_path.outputs.path == 'script' && steps.check_js.outputs.has_js == 'true'
        run: |
          echo "Running JavaScript/TypeScript deprecation detection with ESLint..."
          if [ -f .eslintrc.json ] || [ -f .eslintrc.js ]; then
            npx eslint . --ext .js,.jsx,.ts,.tsx
          else
            echo "No ESLint config found. Skipping JS/TS deprecation check."
            echo "Create .eslintrc.json with eslint-plugin-deprecation to enable."
          fi
        continue-on-error: false

      - name: Validate deprecation whitelist
        if: steps.validation_path.outputs.path == 'script'
        run: |
          echo "Validating .deprecation-whitelist.json..."
          if [ -f .deprecation-whitelist.json ]; then
            python -c "import json; json.load(open('.deprecation-whitelist.json'))"
            echo "✅ Whitelist is valid JSON"
            
            # Check for expired exceptions
            python << 'EOF'
          import json
          from datetime import datetime, timedelta
          
          with open('.deprecation-whitelist.json', 'r') as f:
              whitelist = json.load(f)
          
          exceptions = whitelist.get('exceptions', [])
          today = datetime.now().date()
          expired = []
          
          for exc in exceptions:
              if exc.get('status') == 'active':
                  review_date = datetime.strptime(exc['review_date'], '%Y-%m-%d').date()
                  if review_date < today:
                      expired.append(exc)
          
          if expired:
              print(f"⚠️  WARNING: {len(expired)} exception(s) require quarterly review:")
              for exc in expired:
                  print(f"  - {exc['file']}:{exc['line']} (review due: {exc['review_date']})")
              print("\nSee governance/policies/AUTOMATED_DEPRECATION_DETECTION_GATE.md for review process.")
          else:
              print("✅ No expired exceptions")
          EOF
          else
            echo "⚠️  No whitelist file found (expected for new repository)"
          fi

      - name: Check for deprecated dependencies (Python)
        if: steps.validation_path.outputs.path == 'script' && steps.check_python.outputs.has_python == 'true'
        run: |
          echo "Checking Python dependencies for deprecation notices..."
          if [ -f requirements.txt ] || [ -f pyproject.toml ]; then
            pip install pip-audit || true
            if command -v pip-audit &> /dev/null; then
              pip-audit --desc || echo "⚠️  Some dependencies may have issues. Review above output."
            else
              echo "pip-audit not available. Skipping dependency audit."
            fi
          else
            echo "No Python dependencies to audit."
          fi
        continue-on-error: true

      - name: Check for deprecated dependencies (npm)
        if: steps.validation_path.outputs.path == 'script' && steps.check_js.outputs.has_js == 'true'
        run: |
          echo "Checking npm dependencies for deprecation notices..."
          if [ -f package.json ]; then
            npm audit --audit-level=moderate || echo "⚠️  Some dependencies may have issues. Review above output."
          else
            echo "No npm dependencies to audit."
          fi
        continue-on-error: true

      - name: Evidence-Based Validation (BL-027/028)
        if: steps.validation_path.outputs.path == 'evidence'
        run: |
          echo "=========================================="
          echo "Evidence-Based Validation (BL-027/028)"
          echo "=========================================="
          echo ""
          echo "Validating evidence documents..."
          chmod +x .github/scripts/validate-evidence-based-gate.sh
          .github/scripts/validate-evidence-based-gate.sh
          
          if [ $? -eq 0 ]; then
            echo ""
            echo "✅ Evidence-based validation PASSED"
            echo "Deprecation gate accepts evidence-based validation per BL-027/028."
          else
            echo ""
            echo "❌ Evidence-based validation FAILED"
            echo "Fix errors and retry."
            exit 1
          fi

      - name: Report summary
        if: always()
        run: |
          echo "================================================"
          echo "Deprecation Detection Gate Summary"
          echo "================================================"
          
          VALIDATION_PATH="${{ steps.validation_path.outputs.path }}"
          
          if [ "$VALIDATION_PATH" = "evidence" ]; then
            echo "Validation Method: Evidence-Based (BL-027/028)"
            echo ""
            echo "✓ SCOPE_DECLARATION.md validated"
            echo "✓ PREHANDOVER_PROOF validated"
            echo "✓ Agent attestations confirmed"
            echo ""
            echo "Deprecation checks skipped for evidence-based validation."
            echo "Agent attests to deprecation compliance in PREHANDOVER_PROOF."
          else
            echo "Validation Method: Script-Based (Traditional)"
            echo ""
            echo "Python files: ${{ steps.check_python.outputs.has_python }}"
            echo "JS/TS files: ${{ steps.check_js.outputs.has_js }}"
          fi
          
          echo ""
          echo "Status: Gate checks completed"
          echo ""
          echo "For exception approval process, see:"
          
          if [ "$VALIDATION_PATH" = "evidence" ]; then
            echo "governance/policies/EVIDENCE_BASED_CI_GATE_VALIDATION.md"
          else
            echo "governance/policies/AUTOMATED_DEPRECATION_DETECTION_GATE.md"
          fi
          
          echo "================================================"

      - name: Gate result
        if: always()
        run: |
          VALIDATION_PATH="${{ steps.validation_path.outputs.path }}"
          
          if [ "${{ job.status }}" == "failure" ]; then
            echo "❌ Deprecation detection gate FAILED"
            echo ""
            
            if [ "$VALIDATION_PATH" = "evidence" ]; then
              echo "Evidence-based validation failed. Review errors above and:"
              echo "1. Fix SCOPE_DECLARATION.md or PREHANDOVER_PROOF issues, OR"
              echo "2. Switch to script-based validation by removing evidence documents"
              echo ""
              echo "See: governance/policies/EVIDENCE_BASED_CI_GATE_VALIDATION.md"
            else
              echo "Review errors above and either:"
              echo "1. Fix deprecated API usage, OR"
              echo "2. Request exception approval (see policy document)"
              echo ""
              echo "See: governance/policies/AUTOMATED_DEPRECATION_DETECTION_GATE.md"
            fi
            
            exit 1
          else
            if [ "$VALIDATION_PATH" = "evidence" ]; then
              echo "✅ Deprecation detection gate PASSED (evidence-based validation)"
            else
              echo "✅ Deprecation detection gate PASSED (script-based validation)"
            fi
          fi
