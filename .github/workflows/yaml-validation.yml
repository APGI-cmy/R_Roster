name: YAML Validation

on:
  pull_request:
    branches: [main, develop]
    paths:
      - '**/*.yml'
      - '**/*.yaml'
      - '.github/agents/*.md'
  push:
    branches: [main, develop]
    paths:
      - '**/*.yml'
      - '**/*.yaml'
      - '.github/agents/*.md'
  workflow_dispatch:

permissions:
  contents: read

jobs:
  yamllint:
    name: Yamllint (syntax errors fail)
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Determine Validation Path
        id: validation_path
        run: |
          if [ -f "SCOPE_DECLARATION.md" ] && find . -maxdepth 1 -name "PREHANDOVER_PROOF_*.md" -type f | grep -q .; then
            echo "path=evidence" >> $GITHUB_OUTPUT
            echo "✓ Using evidence-based validation (BL-027/028)"
          else
            echo "path=script" >> $GITHUB_OUTPUT
            echo "✓ Using script-based validation (traditional)"
          fi

      - name: Set up Python
        if: steps.validation_path.outputs.path == 'script'
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install yamllint
        if: steps.validation_path.outputs.path == 'script'
        run: |
          python -m pip install --upgrade pip
          pip install 'yamllint>=1.21.0'

      - name: Run yamllint
        if: steps.validation_path.outputs.path == 'script'
        run: |
          echo "=== Validating YAML files ==="
          
          # Get pure YAML files (not .md)
          YAML_FILES=$(git ls-files '*.yml' '*.yaml')
          
          # Get agent contract files (.md with frontmatter)
          AGENT_FILES=$(git ls-files '.github/agents/*.md')
          
          YAML_ERRORS=0
          
          # Validate pure YAML files normally
          if [ -n "$YAML_FILES" ]; then
            echo "Validating .yml/.yaml files..."
            OUTPUT=$(yamllint -f parsable $YAML_FILES 2>&1 || true)
            
            if echo "$OUTPUT" | grep -qi "syntax error"; then
              echo "❌ YAML syntax errors detected:"
              echo "$OUTPUT"
              YAML_ERRORS=$((YAML_ERRORS + 1))
            elif [ -n "$OUTPUT" ]; then
              echo "⚠️ YAML style warnings (non-blocking):"
              echo "$OUTPUT"
            else
              echo "✅ All .yml/.yaml files valid"
            fi
          fi
          
          # Validate agent contract frontmatter only
          if [ -n "$AGENT_FILES" ]; then
            echo ""
            echo "Validating agent contract YAML frontmatter..."
            
            for FILE in $AGENT_FILES; do
              # Skip documentation files (README, SCHEMA, etc.)
              BASENAME=$(basename "$FILE")
              if [[ "$BASENAME" == "README.md" ]] || [[ "$BASENAME" == "BUILDER_CONTRACT_SCHEMA.md" ]] || [[ "$BASENAME" == *"instruction"* ]]; then
                echo "Skipping documentation file: $FILE"
                continue
              fi
              
              echo "Checking: $FILE"
              
              # Check if file starts with YAML frontmatter marker
              FIRST_LINE=$(head -n 1 "$FILE")
              if [ "$FIRST_LINE" != "---" ]; then
                echo "⚠️ No YAML frontmatter (not an agent contract): $FILE"
                continue
              fi
              
              # Extract YAML frontmatter (between --- markers)
              FRONTMATTER=$(awk '/^---$/{if(++count==2) exit; if(count==1) next} count==1' "$FILE")
              
              if [ -z "$FRONTMATTER" ]; then
                echo "❌ No YAML frontmatter found in $FILE"
                YAML_ERRORS=$((YAML_ERRORS + 1))
                continue
              fi
              
              # Write frontmatter to temp file
              TEMP_YAML=$(mktemp)
              echo "$FRONTMATTER" > "$TEMP_YAML"
              
              # Validate YAML frontmatter only
              OUTPUT=$(yamllint -f parsable "$TEMP_YAML" 2>&1 || true)
              
              if echo "$OUTPUT" | grep -qi "syntax error"; then
                echo "❌ YAML frontmatter syntax error in $FILE"
                echo "$OUTPUT"
                YAML_ERRORS=$((YAML_ERRORS + 1))
              elif [ -n "$OUTPUT" ]; then
                echo "⚠️ YAML frontmatter style warnings (non-blocking)"
                echo "$OUTPUT"
              else
                echo "✅ Valid YAML frontmatter"
              fi
              
              rm "$TEMP_YAML"
            done
          fi
          
          # Final result
          if [ $YAML_ERRORS -gt 0 ]; then
            echo ""
            echo "❌ YAML validation failed with $YAML_ERRORS error(s)"
            exit 1
          else
            echo ""
            echo "✅ All YAML validation passed"
            exit 0
          fi

      - name: Evidence-Based Validation (BL-027/028)
        if: steps.validation_path.outputs.path == 'evidence'
        run: |
          echo "=========================================="
          echo "Evidence-Based Validation (BL-027/028)"
          echo "=========================================="
          echo ""
          echo "Validating evidence documents..."
          chmod +x .github/scripts/validate-evidence-based-gate.sh
          .github/scripts/validate-evidence-based-gate.sh
          
          if [ $? -eq 0 ]; then
            echo ""
            echo "✅ Evidence-based validation PASSED"
            echo "YAML validation gate accepts evidence-based validation per BL-027/028."
            echo "Agent attests to YAML validation compliance in PREHANDOVER_PROOF."
          else
            echo ""
            echo "❌ Evidence-based validation FAILED"
            echo "Fix errors and retry."
            exit 1
          fi
