name: YAML Validation

on:
  pull_request:
    branches: [main, develop]
    paths:
      - '**/*.yml'
      - '**/*.yaml'
      - '.github/agents/*.md'
  push:
    branches: [main, develop]
    paths:
      - '**/*.yml'
      - '**/*.yaml'
      - '.github/agents/*.md'
  workflow_dispatch:

jobs:
  yamllint:
    name: Yamllint (syntax errors fail)
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install yamllint
        run: |
          python -m pip install --upgrade pip
          pip install yamllint

      - name: Run yamllint
        run: |
          TARGETS=$(git ls-files '*.yml' '*.yaml' '.github/agents/*.md')
          if [ -z "$TARGETS" ]; then
            echo "No YAML files found to validate."
            exit 0
          fi

          OUTPUT=$(yamllint -f parsable $TARGETS 2>&1 || true)

          if [ -z "$OUTPUT" ]; then
            echo "✅ YAML validation passed."
            exit 0
          fi

          if echo "$OUTPUT" | grep -qi "syntax error"; then
            echo "❌ YAML syntax errors detected:"
            echo "$OUTPUT"
            exit 1
          fi

          echo "⚠️ YAML style warnings (non-blocking):"
          echo "$OUTPUT"
          echo ""
          echo "Fix command (agent frontmatter): yamllint --fix .github/agents/*.md"
          echo "For other YAML files, run: yamllint --fix <path>"
          echo "If your yamllint installation does not support --fix, resolve the warnings manually."
          exit 0
