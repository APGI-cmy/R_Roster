name: Ripple Integration (Layer-Down Listener)

on:
  issues:
    types: [opened, labeled]
  workflow_dispatch:
    inputs:
      issue_number:
        description: 'Governance layer-down issue number to process'
        required: false
        default: ''

permissions:
  contents: write
  pull-requests: write
  issues: write

jobs:
  layer-down-listener:
    name: layer-down-listener
    runs-on: ubuntu-latest

    # Only process issues with both 'governance' and 'layer-down' labels (matching upstream dispatch)
    if: >
      github.event_name == 'workflow_dispatch' ||
      (github.event_name == 'issues' &&
       contains(github.event.issue.labels.*.name, 'governance') &&
       contains(github.event.issue.labels.*.name, 'layer-down'))

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.MATURION_BOT_TOKEN || secrets.GITHUB_TOKEN }}

      - name: Detect layer-down issue
        id: detect
        run: |
          echo "=========================================="
          echo "Governance Layer-Down Listener"
          echo "=========================================="

          if [ "${{ github.event_name }}" = "issues" ]; then
            ISSUE_NUMBER="${{ github.event.issue.number }}"
            ISSUE_TITLE="${{ github.event.issue.title }}"
            TRIGGER="issue_${{ github.event.action }}"
          else
            ISSUE_NUMBER="${{ github.event.inputs.issue_number }}"
            ISSUE_TITLE="Manual dispatch"
            TRIGGER="workflow_dispatch"
          fi

          echo "Issue number : $ISSUE_NUMBER"
          echo "Issue title  : $ISSUE_TITLE"
          echo "Trigger      : $TRIGGER"

          echo "issue_number=$ISSUE_NUMBER" >> $GITHUB_OUTPUT
          echo "issue_title=$ISSUE_TITLE"   >> $GITHUB_OUTPUT
          echo "trigger=$TRIGGER"           >> $GITHUB_OUTPUT

          echo "=========================================="

      - name: Fetch canonical governance
        id: fetch
        run: |
          echo "Fetching canonical governance for layer-down..."

          TEMP_DIR=$(mktemp -d)
          git clone --depth 1 --branch main \
            "https://github.com/APGI-cmy/maturion-foreman-governance.git" "$TEMP_DIR" || {
            echo "::error::Failed to clone canonical governance repository"
            exit 1
          }

          echo "‚úì Canonical repository fetched"

          # Sync governance directory (exclude local-only files)
          rsync -av --delete \
            --exclude='.git' \
            --exclude='*.log' \
            --exclude='sync_state.json' \
            "$TEMP_DIR/governance/" governance/ || {
            echo "::error::Failed to sync governance files"
            rm -rf "$TEMP_DIR"
            exit 1
          }

          rm -rf "$TEMP_DIR"

          # Detect changed files
          CHANGED_FILES=$(git --no-pager diff --name-only HEAD)
          echo "Changed files:"
          echo "$CHANGED_FILES"

          # Check whether any agent contract files changed
          AGENT_FILES_CHANGED="false"
          if echo "$CHANGED_FILES" | grep -qE '^\.github/agents/'; then
            AGENT_FILES_CHANGED="true"
            echo "‚ö†Ô∏è  Agent file change detected"
          fi

          echo "agent_files_changed=$AGENT_FILES_CHANGED" >> $GITHUB_OUTPUT
          echo "changed_files<<EOF"                        >> $GITHUB_OUTPUT
          echo "$CHANGED_FILES"                            >> $GITHUB_OUTPUT
          echo "EOF"                                       >> $GITHUB_OUTPUT

      - name: Log layer-down event
        id: log_event
        if: always()
        run: |
          TIMESTAMP=$(date -u +"%Y%m%dT%H%M%SZ")
          mkdir -p .agent-admin/ripple

          LOG_FILE=".agent-admin/ripple/layerdown-${TIMESTAMP}.json"
          cat > "$LOG_FILE" <<EOF
          {
            "timestamp": "$(date -u +"%Y-%m-%dT%H:%M:%SZ")",
            "issue_number": "${{ steps.detect.outputs.issue_number }}",
            "issue_title": "${{ steps.detect.outputs.issue_title }}",
            "trigger": "${{ steps.detect.outputs.trigger }}",
            "agent_files_changed": ${{ steps.fetch.outputs.agent_files_changed || 'false' }},
            "action_taken": "${{ steps.fetch.outputs.agent_files_changed == 'true' && 'DRAFT_ESCALATION' || 'AUTO_MERGE_PR' }}"
          }
          EOF

          echo "log_file=$LOG_FILE" >> $GITHUB_OUTPUT
          echo "Layer-down log created: $LOG_FILE"
          cat "$LOG_FILE"

      - name: Create escalation file (agent files changed)
        id: escalate
        if: steps.fetch.outputs.agent_files_changed == 'true'
        run: |
          DATE=$(date -u +"%Y%m%d")
          ESCALATION_DIR=".agent-workspace/governance-liaison/escalation-inbox"
          mkdir -p "$ESCALATION_DIR"

          ESCALATION_FILE="${ESCALATION_DIR}/blocker-${DATE}-issue-${{ steps.detect.outputs.issue_number }}.md"

          cat > "$ESCALATION_FILE" <<'MDEOF'
          # Escalation: Agent File Change Detected in Governance Layer-Down

          ## Type
          BLOCKER

          ## Description
          Agent file(s) detected in governance layer-down issue #ISSUE_NUMBER.
          CS2 review required before merge.

          ## Context
          - Issue: #ISSUE_NUMBER ‚Äî ISSUE_TITLE
          - Detected: DETECTED_TIMESTAMP
          - Trigger: TRIGGER_VALUE

          ## Changed Agent Files
          CHANGED_FILES_LIST

          ## Recommendation
          1. CS2 reviews the agent file changes in the associated draft PR.
          2. If approved, CS2 removes the `escalation:agent-files` label and approves the PR.
          3. If rejected, CS2 closes the draft PR and documents the reason.

          ---
          Authority: AGENT_CONTRACT_MANAGEMENT_PROTOCOL.md v3.1.0 | Living Agent System v6.2.0
          MDEOF

          # Substitute placeholders
          ISSUE_NUMBER="${{ steps.detect.outputs.issue_number }}"
          ISSUE_TITLE="${{ steps.detect.outputs.issue_title }}"
          DETECTED_TIMESTAMP=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
          TRIGGER_VALUE="${{ steps.detect.outputs.trigger }}"
          CHANGED_FILES_LIST="${{ steps.fetch.outputs.changed_files }}"

          sed -i "s|ISSUE_NUMBER|$ISSUE_NUMBER|g" "$ESCALATION_FILE"
          sed -i "s|ISSUE_TITLE|$ISSUE_TITLE|g" "$ESCALATION_FILE"
          sed -i "s|DETECTED_TIMESTAMP|$DETECTED_TIMESTAMP|g" "$ESCALATION_FILE"
          sed -i "s|TRIGGER_VALUE|$TRIGGER_VALUE|g" "$ESCALATION_FILE"
          sed -i "s|CHANGED_FILES_LIST|$CHANGED_FILES_LIST|g" "$ESCALATION_FILE"

          echo "escalation_file=$ESCALATION_FILE" >> $GITHUB_OUTPUT
          echo "‚úÖ Escalation file created: $ESCALATION_FILE"

      - name: Update layer-down log with escalation path
        if: steps.fetch.outputs.agent_files_changed == 'true' && steps.escalate.outputs.escalation_file != ''
        run: |
          LOG_FILE="${{ steps.log_event.outputs.log_file }}"
          if [ -n "$LOG_FILE" ] && [ -f "$LOG_FILE" ]; then
            jq --arg ef "${{ steps.escalate.outputs.escalation_file }}" \
               '. + {escalation_file: $ef}' "$LOG_FILE" > "${LOG_FILE}.tmp" && mv "${LOG_FILE}.tmp" "$LOG_FILE"
          fi

      - name: Create governance alignment PR
        id: create_pr
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          AGENT_FILES_CHANGED="${{ steps.fetch.outputs.agent_files_changed }}"

          # Determine branch and PR mode
          if [ "$AGENT_FILES_CHANGED" = "true" ]; then
            BRANCH_NAME="governance-layerdown-draft-${{ steps.detect.outputs.issue_number }}"
            PR_DRAFT_FLAG="--draft"
            PR_LABEL_EXTRA="--label escalation:agent-files"
            PR_NOTE="‚ö†Ô∏è **DRAFT ‚Äî Escalation Required**: Agent contract file(s) changed. CS2 review required before merge."
          else
            BRANCH_NAME="governance-layerdown-${{ steps.detect.outputs.issue_number }}"
            PR_DRAFT_FLAG=""
            PR_LABEL_EXTRA=""
            PR_NOTE="‚úÖ No agent contract files changed. Eligible for auto-merge after checks pass."
          fi

          PR_TITLE="[Governance] Layer-down alignment from issue #${{ steps.detect.outputs.issue_number }}"

          # Check for existing open PR on this branch
          EXISTING_PR=$(gh pr list --head "$BRANCH_NAME" --state open --json number --jq '.[0].number' 2>/dev/null || echo "")
          if [ -n "$EXISTING_PR" ]; then
            echo "‚ö†Ô∏è  Existing open PR #$EXISTING_PR found on branch $BRANCH_NAME ‚Äî skipping creation"
            echo "pr_number=$EXISTING_PR" >> $GITHUB_OUTPUT
            exit 0
          fi

          # Stage and commit governance changes
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"

          git checkout -b "$BRANCH_NAME"
          git add governance/ .agent-admin/ripple/ .agent-workspace/governance-liaison/escalation-inbox/

          if git diff --staged --quiet; then
            echo "No governance changes to commit ‚Äî skipping PR"
            exit 0
          fi

          git commit -m "chore: governance layer-down from issue #${{ steps.detect.outputs.issue_number }}"
          git push origin "$BRANCH_NAME"

          # Build PR body
          PR_BODY="## Governance Layer-Down Alignment

          **Source Issue**: #${{ steps.detect.outputs.issue_number }} ‚Äî ${{ steps.detect.outputs.issue_title }}
          **Timestamp**: $(date -u +"%Y-%m-%d %H:%M:%S UTC")
          **Trigger**: ${{ steps.detect.outputs.trigger }}
          **Canonical Source**: APGI-cmy/maturion-foreman-governance

          $PR_NOTE

          ### Authority
          - CROSS_REPOSITORY_LAYER_DOWN_PROTOCOL.md
          - CROSS_REPO_RIPPLE_TRANSPORT_PROTOCOL.md
          - LIVING_AGENT_SYSTEM.md v6.2.0
          - Governance Liaison self-alignment authority (Issue #999)"

          # Create PR (draft if agent files changed)
          PR_NUMBER=$(gh pr create \
            --title "$PR_TITLE" \
            --body "$PR_BODY" \
            --base main \
            --head "$BRANCH_NAME" \
            $PR_DRAFT_FLAG \
            --label "governance" \
            --label "automated" \
            --label "agent:liaison" \
            $PR_LABEL_EXTRA | grep -oE '[0-9]+$' || echo "")

          if [ -z "$PR_NUMBER" ]; then
            echo "::error::Failed to create PR"
            exit 1
          fi

          echo "‚úÖ PR #$PR_NUMBER created (draft=$AGENT_FILES_CHANGED)"
          echo "pr_number=$PR_NUMBER" >> $GITHUB_OUTPUT

      - name: Enable auto-merge (no agent files changed)
        if: steps.fetch.outputs.agent_files_changed != 'true' && steps.create_pr.outputs.pr_number != ''
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          PR_NUMBER="${{ steps.create_pr.outputs.pr_number }}"
          echo "Enabling auto-merge for PR #$PR_NUMBER"
          gh pr merge "$PR_NUMBER" --auto --squash || echo "‚ö†Ô∏è  Auto-merge failed (branch protection may need enabling)"

      - name: Comment on source issue
        if: steps.detect.outputs.issue_number != '' && steps.create_pr.outputs.pr_number != ''
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          ISSUE_NUMBER="${{ steps.detect.outputs.issue_number }}"
          PR_NUMBER="${{ steps.create_pr.outputs.pr_number }}"
          AGENT_FILES_CHANGED="${{ steps.fetch.outputs.agent_files_changed }}"

          if [ "$AGENT_FILES_CHANGED" = "true" ]; then
            COMMENT="üö® **Governance Liaison ‚Äî Escalation Required**

          Layer-down alignment draft PR #$PR_NUMBER has been created, but **agent contract file(s) were detected in the changes**.

          **Action Required**: CS2 must review PR #$PR_NUMBER before it can be merged.
          An escalation file has been created in \`.agent-workspace/governance-liaison/escalation-inbox/\`.

          _Authority: AGENT_CONTRACT_MANAGEMENT_PROTOCOL.md v3.1.0_"
          else
            COMMENT="‚úÖ **Governance Liaison ‚Äî Auto Layer-Down Initiated**

          Layer-down alignment PR #$PR_NUMBER has been created and auto-merge is enabled.
          It will merge automatically after all checks pass.

          _Authority: CROSS_REPOSITORY_LAYER_DOWN_PROTOCOL.md | Living Agent System v6.2.0_"
          fi

          gh issue comment "$ISSUE_NUMBER" --body "$COMMENT" || echo "‚ö†Ô∏è  Could not comment on issue (may not exist)"

      - name: Commit log and escalation artifacts
        if: always()
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"

          # Return to main branch to commit tracking artifacts
          CURRENT_BRANCH=$(git rev-parse --abbrev-ref HEAD)
          if [ "$CURRENT_BRANCH" != "main" ]; then
            git checkout main 2>/dev/null || true
          fi

          git add .agent-admin/ripple/ .agent-workspace/governance-liaison/escalation-inbox/ || true

          if git diff --staged --quiet; then
            echo "No tracking artifacts to commit"
          else
            git commit -m "chore: record layer-down event and escalation [skip ci]"
            git push origin main || echo "‚ö†Ô∏è  Push to main failed (check branch protection)"
          fi

# Authority: CROSS_REPO_RIPPLE_TRANSPORT_PROTOCOL.md | CROSS_REPOSITORY_LAYER_DOWN_PROTOCOL.md
# Governance Liaison self-alignment authority (Issue #999) | Living Agent System v6.2.0
