name: Governance Alignment Schedule

on:
  schedule:
    # Run every hour (as required by CROSS_REPO_RIPPLE_TRANSPORT_PROTOCOL.md)
    - cron: '0 * * * *'
  workflow_dispatch:
    inputs:
      detailed_output:
        description: 'Enable detailed drift analysis output'
        required: false
        default: 'false'

permissions:
  contents: write
  pull-requests: write
  issues: write

jobs:
  scheduled-alignment-check:
    name: scheduled-governance-alignment
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Check last sync time
        id: sync_check
        run: |
          echo "=========================================="
          echo "Scheduled Governance Alignment Check"
          echo "=========================================="

          SYNC_STATE=".agent-admin/governance/sync_state.json"

          if [ -f "$SYNC_STATE" ]; then
            LAST_SYNC=$(jq -r '.last_sync // "never"' "$SYNC_STATE")
            ALIGNMENT_STATE=$(jq -r '.alignment_state // "UNKNOWN"' "$SYNC_STATE")

            echo "Last sync: $LAST_SYNC"
            echo "Alignment state: $ALIGNMENT_STATE"

            # Calculate time since last sync
            if [ "$LAST_SYNC" != "never" ]; then
              LAST_SYNC_EPOCH=$(date -d "$LAST_SYNC" +%s 2>/dev/null || echo 0)
              CURRENT_EPOCH=$(date +%s)
              HOURS_SINCE_SYNC=$(( (CURRENT_EPOCH - LAST_SYNC_EPOCH) / 3600 ))

              echo "Hours since last sync: $HOURS_SINCE_SYNC"

              if [ $HOURS_SINCE_SYNC -gt 24 ]; then
                echo "⚠️  Drift window exceeded 24 hours!"
                echo "needs_alignment=true" >> $GITHUB_OUTPUT
              fi
            else
              echo "needs_alignment=true" >> $GITHUB_OUTPUT
            fi

            if [ "$ALIGNMENT_STATE" = "DRIFT_DETECTED" ]; then
              echo "⚠️  Drift previously detected - needs remediation"
              echo "needs_alignment=true" >> $GITHUB_OUTPUT
            fi
          else
            echo "⚠️  No sync state found - initializing"
            echo "needs_alignment=true" >> $GITHUB_OUTPUT
          fi

          echo "=========================================="

      - name: Run drift detection
        id: drift_check
        run: |
          echo "Running drift detection..."

          # Use check-governance-drift.sh if available
          if [ -f ".github/scripts/check-governance-drift.sh" ]; then
            bash .github/scripts/check-governance-drift.sh
          else
            echo "Drift detection script not found - performing basic checks"

            # Basic integrity checks
            DRIFT_DETECTED=false

            # Check CANON_INVENTORY exists
            if [ ! -f "governance/CANON_INVENTORY.json" ]; then
              echo "❌ CANON_INVENTORY.json missing"
              DRIFT_DETECTED=true
            fi

            # Check TIER_0_CANON_MANIFEST exists
            if [ ! -f "governance/TIER_0_CANON_MANIFEST.json" ]; then
              echo "❌ TIER_0_CANON_MANIFEST.json missing"
              DRIFT_DETECTED=true
            fi

            # Check sync_state exists
            if [ ! -f ".agent-admin/governance/sync_state.json" ]; then
              echo "❌ sync_state.json missing"
              DRIFT_DETECTED=true
            fi

            if [ "$DRIFT_DETECTED" = true ]; then
              echo "drift_detected=true" >> $GITHUB_OUTPUT
              echo "❌ Drift detected"
            else
              echo "drift_detected=false" >> $GITHUB_OUTPUT
              echo "✓ No drift detected"
            fi
          fi

      - name: Execute alignment if needed
        if: steps.sync_check.outputs.needs_alignment == 'true' || steps.drift_check.outputs.drift_detected == 'true'
        run: |
          echo "Executing alignment..."

          if [ -f ".github/scripts/align-governance.sh" ]; then
            bash .github/scripts/align-governance.sh
          else
            echo "⚠️  Alignment script not found"
            echo "Manual alignment required"
          fi

      - name: Update sync state
        if: always()
        run: |
          TIMESTAMP=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
          SYNC_STATE=".agent-admin/governance/sync_state.json"

          mkdir -p .agent-admin/governance

          # Update or create sync state
          if [ -f "$SYNC_STATE" ]; then
            jq --arg ts "$TIMESTAMP" \
               --arg state "${{ steps.drift_check.outputs.drift_detected == 'true' && 'DRIFT_DETECTED' || 'ALIGNED' }}" \
               '.last_sync = $ts | .alignment_state = $state | .last_scheduled_check = $ts' \
               "$SYNC_STATE" > "${SYNC_STATE}.tmp" && mv "${SYNC_STATE}.tmp" "$SYNC_STATE"
          else
            cat > "$SYNC_STATE" <<EOF
          {
            "timestamp": "$TIMESTAMP",
            "alignment_state": "${{ steps.drift_check.outputs.drift_detected == 'true' && 'DRIFT_DETECTED' || 'ALIGNED' }}",
            "last_sync": "$TIMESTAMP",
            "last_scheduled_check": "$TIMESTAMP",
            "canonical_source": "APGI-cmy/maturion-foreman-governance",
            "drift_detected": ${{ steps.drift_check.outputs.drift_detected == 'true' && 'true' || 'false' }},
            "notes": "Scheduled alignment check"
          }
          EOF
          fi

          echo "Sync state updated:"
          cat "$SYNC_STATE"

      - name: Create alignment evidence
        if: always()
        run: |
          TIMESTAMP=$(date -u +"%Y%m%dT%H%M%SZ")
          EVIDENCE_DIR=".agent-admin/evidence/governance-liaison/scheduled-${TIMESTAMP}"

          mkdir -p "$EVIDENCE_DIR"

          # Create evidence log
          cat > "$EVIDENCE_DIR/evidence-log.json" <<EOF
          {
            "session_type": "scheduled_alignment",
            "timestamp": "$TIMESTAMP",
            "trigger": "schedule",
            "drift_detected": "${{ steps.drift_check.outputs.drift_detected }}",
            "needs_alignment": "${{ steps.sync_check.outputs.needs_alignment }}",
            "alignment_status": "${{ steps.drift_check.outputs.drift_detected == 'true' && 'DRIFT_DETECTED' || 'ALIGNED' }}",
            "sync_state": ".agent-admin/governance/sync_state.json"
          }
          EOF

          echo "Evidence created at: $EVIDENCE_DIR"

      - name: Commit sync state updates
        if: always()
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"

          git add .agent-admin/governance/
          git add .agent-admin/evidence/

          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            git commit -m "chore: scheduled governance alignment check [skip ci]"
            git push
          fi

      - name: Escalate if drift persists
        if: steps.drift_check.outputs.drift_detected == 'true'
        run: |
          echo "=========================================="
          echo "⚠️  GOVERNANCE DRIFT DETECTED"
          echo "=========================================="
          echo "Drift was detected during scheduled check."
          echo "Review .agent-admin/governance/sync_state.json"
          echo "Manual remediation may be required."
          echo "=========================================="

          # Create escalation file if drift persists
          ESCALATION_DIR=".agent-workspace/governance-liaison/escalation-inbox"
          mkdir -p "$ESCALATION_DIR"

          TIMESTAMP=$(date -u +"%Y-%m-%d")
          ESCALATION_FILE="$ESCALATION_DIR/drift-detected-${TIMESTAMP}.md"

          if [ ! -f "$ESCALATION_FILE" ]; then
            cat > "$ESCALATION_FILE" <<EOF
          # Escalation: Governance Drift Detected

          ## Type
          GOVERNANCE_GAP

          ## Description
          Scheduled governance alignment check detected drift between local and canonical governance.

          ## Context
          - Detection: Scheduled alignment workflow
          - Timestamp: $(date -u +"%Y-%m-%dT%H:%M:%SZ")
          - Sync state: .agent-admin/governance/sync_state.json

          ## Recommendation
          Execute governance alignment to synchronize with canonical source.

          ---
          Created: Scheduled Check | Date: $TIMESTAMP
          EOF

            echo "Escalation created: $ESCALATION_FILE"
          fi

      # ✅ NEW: Create alignment PR with duplicate prevention and auto-merge
      - name: Create governance alignment PR
        if: steps.drift_check.outputs.drift_detected == 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "=========================================="
          echo "Creating Governance Alignment PR"
          echo "=========================================="
          
          # ✅ Stable branch name
          BRANCH_NAME="governance-alignment-auto"
          PR_TITLE="[Governance] Scheduled governance alignment"
          
          # ✅ Check for existing open PR
          EXISTING_PR=$(gh pr list --head "$BRANCH_NAME" --state open --json number --jq '.[0].number' 2>/dev/null || echo "")
          
          if [ -n "$EXISTING_PR" ]; then
            echo "⚠️  Open governance alignment PR already exists: #$EXISTING_PR"
            echo "   Skipping PR creation to prevent duplicates"
            echo "   Existing PR will be updated by subsequent alignment"
            exit 0
          fi
          
          echo "✓ No existing open governance alignment PR found"
          echo "   Proceeding with PR creation"
          
          # Create alignment branch
          git checkout -b "$BRANCH_NAME" || git checkout "$BRANCH_NAME"
          
          # Add governance changes
          git add governance/
          git add .agent-admin/
          git add .agent-workspace/
          
          if git diff --staged --quiet; then
            echo "⚠️  No governance changes to commit"
            exit 0
          fi
          
          git commit -m "chore: scheduled governance alignment"
          git push -f origin "$BRANCH_NAME"
          
          # Create PR with labels
          PR_BODY="## Automated Governance Alignment
          
          **Trigger**: Scheduled alignment check
          **Timestamp**: $(date -u +"%Y-%m-%d %H:%M:%S UTC")
          **Canonical Source**: APGI-cmy/maturion-foreman-governance
          
          ### Changes
          This PR synchronizes local governance with the canonical governance repository.
          
          ### Validation
          - Governance alignment validated by scheduled check
          - SHA256 checksums verified
          - Canonical source is trusted
          
          ### Authority
          - CROSS_REPO_RIPPLE_TRANSPORT_PROTOCOL.md
          - LIVING_AGENT_SYSTEM.md v6.2.0
          
          **Note**: This PR is auto-generated by the governance ripple system and will auto-merge after passing checks."
          
          # Create PR
          PR_NUMBER=$(gh pr create \
            --title "$PR_TITLE" \
            --body "$PR_BODY" \
            --base main \
            --head "$BRANCH_NAME" \
            --label "governance" \
            --label "automated" \
            --label "agent:liaison" | grep -oP '\d+$' || echo "")
          
          if [ -z "$PR_NUMBER" ]; then
            echo "❌ Failed to create PR"
            exit 1
          fi
          
          echo "✅ PR created: #$PR_NUMBER"
          
          # ✅ Enable auto-merge
          echo ""
          echo "Enabling auto-merge for PR #$PR_NUMBER"
          gh pr merge "$PR_NUMBER" --auto --squash || echo "⚠️  Auto-merge failed (may need branch protection settings)"
          
          echo "=========================================="

# Per CROSS_REPO_RIPPLE_TRANSPORT_PROTOCOL.md:
# - Scheduled fallback runs every 60 minutes (mandatory)
# - Recovers from missed dispatch events
# - SLA: No drift for more than 24 hours
# - Escalation on persistent drift
# - Stable branch naming prevents duplicate PRs
# - Auto-merge enabled for governance alignment PRs
